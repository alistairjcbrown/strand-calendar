on: [workflow_dispatch]

jobs:
  generate_calendar:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Setup
      - uses: actions/checkout@v3
      - id: date
        run: echo "{currentDate}={$(TZ=Europe/Belfast date +'%Y-%m-%d')}" >> $GITHUB_STATE
      - id: time
        run: echo "{currentTime}={$(TZ=Europe/Belfast date +'%H:%M:%S')}" >> $GITHUB_STATE
      - uses: actions/setup-node@v3
        with:
          node-version-file: .node-version
      - run: npm ci

      # Generate files
      - run: node index.js

      # Create release with assets
      - uses: ncipollo/release-action@v1
        with:
          allowUpdates: false
          artifactErrorsFailBuild: true
          artifacts: "strand-calendar.ics,strand-shows.json"
          # TODO: Undo the two changes below when we're ready to go
          makeLatest: false
          tag: test-${{ steps.date.outputs.currentDate }}
          commit: main
          body: "Calendar and data files generated at ${{ steps.time.outputs.currentTime }} on ${{ steps.date.outputs.currentDate }}"
